<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using plyranges to perform common genomic data wrangling tasks • plyranges</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">plyranges</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/01-introduction-plyranges.html">Introduction to the plyranges package</a>
    </li>
    <li>
      <a href="../articles/02-bedtools-examples.html">Using plyranges to perform common genomic data wrangling tasks</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Using plyranges to perform common genomic data wrangling tasks</h1>
                        <h4 class="author">Stuart Lee</h4>
            
            <h4 class="date">2017-11-29</h4>
          </div>

    
        <div class="abstract">
      <p class="abstract">Abstract</p>
      A fluent interface to <code>Ranges</code> classes.
    </div>
    
<div class="contents">
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>Here we introduce the <code>plyranges</code> API for manipulating genomic data. The examples follow the <a href="http://bioconductor.org/packages/release/bioc/vignettes/HelloRanges/inst/doc/tutorial.pdf">HelloRanges tutorial</a>. The aim is to show how common analysis tasks that are usually undertaken using <code>bedtools</code> can be performed interactively using the <code>plyranges</code> API. Throughout this tutorial we will highlight how the <code>bedtools</code>, <code>HelloRanges</code> and <code>plyranges</code> API differ.</p>
<p>The <code>plyranges</code> API attempts to be type-consistent, that is if you apply a <code>plyranges</code> function to a <em>Ranges</em> object it should return a <em>Ranges</em> object. This means that intermittant Bioconductor classes such as <code>Rle</code> objects are hidden away from the user, and the user can focus on the table-like structure of ordinary <em>Ranges</em> objects. A <em>Ranges</em> object, in particular a <em>GRanges</em> object resembles a BED file and has columns to represent the chromomsome, start, end, and strand information. It can also contain additional columns called metadata containing information about the rows (i.e an exon name or a measurement).</p>
</div>
<div id="data" class="section level1">
<h1 class="hasAnchor">
<a href="#data" class="anchor"></a>Data</h1>
<p>The data we use for these examples are exported by the <code>HelloRangesData</code> package. For more details see that <a href="http://bioconductor.org/packages/release/data/experiment/vignettes/HelloRangesData/inst/doc/intro.pdf">package’s vignette</a>. For most examples in this tutorial we will use the RefSeq exons and CpG island annotations from the hg19 genome build.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">exons_bed &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">"extdata"</span>, <span class="st">"exons.bed"</span>, <span class="dt">package=</span><span class="st">"HelloRangesData"</span>)
cpg_bed &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">"extdata"</span>, <span class="st">"cpg.bed"</span>, <span class="dt">package =</span> <span class="st">"HelloRangesData"</span>)</code></pre></div>
</div>
<div id="reading-bed-files" class="section level1">
<h1 class="hasAnchor">
<a href="#reading-bed-files" class="anchor"></a>Reading BED files</h1>
<p>To load the exons file as a <em>GRanges</em> object we use the <code>read_bed</code> function. We supply the genome build as an additional argument to this function, allowing us to obtain annotation information about each chromosome.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(plyranges))
cpg &lt;-<span class="st"> </span><span class="kw"><a href="../reference/bed-files-read.html">read_bed</a></span>(cpg_bed, <span class="dt">genome_info =</span> <span class="st">"hg19"</span>)
cpg</code></pre></div>
<pre><code>## GRanges object with 28691 ranges and 1 metadata column:
##           seqnames               ranges strand |        name
##              &lt;Rle&gt;            &lt;IRanges&gt;  &lt;Rle&gt; | &lt;character&gt;
##       [1]     chr1     [ 28736,  29810]      * |    CpG:_116
##       [2]     chr1     [135125, 135563]      * |     CpG:_30
##       [3]     chr1     [327791, 328229]      * |     CpG:_29
##       [4]     chr1     [437152, 438164]      * |     CpG:_84
##       [5]     chr1     [449274, 450544]      * |     CpG:_99
##       ...      ...                  ...    ... .         ...
##   [28687]     chrY [27610116, 27611088]      * |     CpG:_76
##   [28688]     chrY [28555536, 28555932]      * |     CpG:_32
##   [28689]     chrY [28773316, 28773544]      * |     CpG:_25
##   [28690]     chrY [59213795, 59214183]      * |     CpG:_36
##   [28691]     chrY [59349267, 59349574]      * |     CpG:_29
##   -------
##   seqinfo: 93 sequences from hg19 genome</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">exons &lt;-<span class="st"> </span><span class="kw"><a href="../reference/bed-files-read.html">read_bed</a></span>(exons_bed, <span class="dt">genome_info =</span> <span class="kw"><a href="../reference/ranges-info-get.html">get_genome_info</a></span>(cpg))
exons</code></pre></div>
<pre><code>## GRanges object with 459752 ranges and 2 metadata columns:
##            seqnames               ranges strand |
##               &lt;Rle&gt;            &lt;IRanges&gt;  &lt;Rle&gt; |
##        [1]     chr1       [11874, 12227]      + |
##        [2]     chr1       [12613, 12721]      + |
##        [3]     chr1       [13221, 14409]      + |
##        [4]     chr1       [14362, 14829]      - |
##        [5]     chr1       [14970, 15038]      - |
##        ...      ...                  ...    ... .
##   [459748]     chrY [59338754, 59338859]      + |
##   [459749]     chrY [59338754, 59338859]      + |
##   [459750]     chrY [59340194, 59340278]      + |
##   [459751]     chrY [59342487, 59343488]      + |
##   [459752]     chrY [59342487, 59343488]      + |
##                                          name     score
##                                   &lt;character&gt; &lt;numeric&gt;
##        [1]    NR_046018_exon_0_0_chr1_11874_f         0
##        [2]    NR_046018_exon_1_0_chr1_12613_f         0
##        [3]    NR_046018_exon_2_0_chr1_13221_f         0
##        [4]    NR_024540_exon_0_0_chr1_14362_r         0
##        [5]    NR_024540_exon_1_0_chr1_14970_r         0
##        ...                                ...       ...
##   [459748] NM_002186_exon_6_0_chrY_59338754_f         0
##   [459749] NM_176786_exon_7_0_chrY_59338754_f         0
##   [459750] NM_002186_exon_7_0_chrY_59340194_f         0
##   [459751] NM_002186_exon_8_0_chrY_59342487_f         0
##   [459752] NM_176786_exon_8_0_chrY_59342487_f         0
##   -------
##   seqinfo: 93 sequences from hg19 genome</code></pre>
</div>
<div id="intersections-and-overlaps" class="section level1">
<h1 class="hasAnchor">
<a href="#intersections-and-overlaps" class="anchor"></a>Intersections and Overlaps</h1>
<p>A useful operation on two <em>Ranges</em> is to identify where they intersect. By default <code>bedtools</code> will return the region of intersection between two genomic tracks. In <code>plyranges</code> the intersect operation is a type of overlap join, that is we are finding the common genomic intervals that overlap between the two tracks.</p>
<p>In <code>plyranges</code> this is termed an left overlap join:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">intersect_rng &lt;-<span class="st"> </span><span class="kw"><a href="../reference/overlap-joins.html">join_overlap_inner</a></span>(cpg, exons)
intersect_rng</code></pre></div>
<pre><code>## GRanges object with 45500 ranges and 5 metadata columns:
##           seqnames               ranges strand |   width.x   width.y
##              &lt;Rle&gt;            &lt;IRanges&gt;  &lt;Rle&gt; | &lt;integer&gt; &lt;integer&gt;
##       [1]     chr1     [ 29321,  29370]      * |      1075        50
##       [2]     chr1     [135125, 135563]      * |       439      4924
##       [3]     chr1     [327791, 328229]      * |       439      4143
##       [4]     chr1     [327791, 328229]      * |       439      4143
##       [5]     chr1     [327791, 328229]      * |       439      1546
##       ...      ...                  ...    ... .       ...       ...
##   [45496]     chrY [59213949, 59214117]      * |       389       169
##   [45497]     chrY [59213949, 59214117]      * |       389       169
##   [45498]     chrY [59213949, 59214117]      * |       389       169
##   [45499]     chrY [59213949, 59214117]      * |       389       169
##   [45500]     chrY [59213949, 59214117]      * |       389       169
##                name.x                                name.y     score
##           &lt;character&gt;                           &lt;character&gt; &lt;numeric&gt;
##       [1]    CpG:_116      NR_024540_exon_10_0_chr1_29321_r         0
##       [2]     CpG:_30      NR_039983_exon_0_0_chr1_134773_r         0
##       [3]     CpG:_29      NR_028322_exon_2_0_chr1_324439_f         0
##       [4]     CpG:_29      NR_028325_exon_2_0_chr1_324439_f         0
##       [5]     CpG:_29      NR_028327_exon_3_0_chr1_327036_f         0
##       ...         ...                                   ...       ...
##   [45496]     CpG:_36 NM_001145149_exon_0_0_chrY_59213949_f         0
##   [45497]     CpG:_36 NM_001185183_exon_0_0_chrY_59213949_f         0
##   [45498]     CpG:_36    NM_005638_exon_0_0_chrY_59213949_f         0
##   [45499]     CpG:_36    NR_033714_exon_0_0_chrY_59213949_f         0
##   [45500]     CpG:_36    NR_033715_exon_0_0_chrY_59213949_f         0
##   -------
##   seqinfo: 93 sequences from hg19 genome</code></pre>
<p>In the <code>HelloRanges</code> API (we also see the <code>bedtools</code> code here) the equivalent operation is:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(HelloRanges))
code &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/HelloRanges/topics/bedtools_intersect">bedtools_intersect</a></span>(<span class="st">"-a cpg.bed -b exons.bed -g hg19"</span>)
code</code></pre></div>
<pre><code>## {
##     genome &lt;- Seqinfo(genome = "hg19")
##     gr_a &lt;- import("cpg.bed", genome = genome)
##     gr_b &lt;- import("exons.bed", genome = genome)
##     pairs &lt;- findOverlapPairs(gr_a, gr_b, ignore.strand = TRUE)
##     ans &lt;- pintersect(pairs, ignore.strand = TRUE)
##     ans
## }</code></pre>
<div id="keeping-the-original-features" class="section level2">
<h2 class="hasAnchor">
<a href="#keeping-the-original-features" class="anchor"></a>Keeping the original features</h2>
<p>By default an overlap join will keep the information in both the query and subject ranges.</p>
</div>
<div id="computing-the-amount-of-overlap" class="section level2">
<h2 class="hasAnchor">
<a href="#computing-the-amount-of-overlap" class="anchor"></a>Computing the amount of overlap</h2>
<p>To compute the amount of overlap we store the width of the intersecting ranges as an additional column using the <code>mutate</code> operator.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">intersect_rng &lt;-<span class="st"> </span>intersect_rng <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">overlap_width =</span> width)</code></pre></div>
<p>The equivalent bedtools/HelloRanges command is:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="http://www.rdocumentation.org/packages/HelloRanges/topics/bedtools_intersect">bedtools_intersect</a></span>(<span class="st">"-a cpg.bed -b exons.bed -g hg19 -wo"</span>)</code></pre></div>
<pre><code>## {
##     genome &lt;- Seqinfo(genome = "hg19")
##     gr_a &lt;- import("cpg.bed", genome = genome)
##     gr_b &lt;- import("exons.bed", genome = genome)
##     pairs &lt;- findOverlapPairs(gr_a, gr_b, ignore.strand = TRUE)
##     ans &lt;- pairs
##     mcols(ans)$overlap_width &lt;- width(pintersect(ans, ignore.strand = TRUE))
##     ans
## }</code></pre>
</div>
<div id="counting-the-number-of-overlaps" class="section level2">
<h2 class="hasAnchor">
<a href="#counting-the-number-of-overlaps" class="anchor"></a>Counting the number of overlaps</h2>
<p>To add the count of the number of times each cpg island overlaps an exon we can use <code>mutate</code> with the <code>count_overlaps</code> function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cpg <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">overlaps =</span> <span class="kw"><a href="../reference/ranges-count-overlaps.Rd.html">count_overlaps</a></span>(., exons))</code></pre></div>
<pre><code>## GRanges object with 28691 ranges and 2 metadata columns:
##           seqnames               ranges strand |        name  overlaps
##              &lt;Rle&gt;            &lt;IRanges&gt;  &lt;Rle&gt; | &lt;character&gt; &lt;integer&gt;
##       [1]     chr1     [ 28736,  29810]      * |    CpG:_116         1
##       [2]     chr1     [135125, 135563]      * |     CpG:_30         1
##       [3]     chr1     [327791, 328229]      * |     CpG:_29         3
##       [4]     chr1     [437152, 438164]      * |     CpG:_84         0
##       [5]     chr1     [449274, 450544]      * |     CpG:_99         0
##       ...      ...                  ...    ... .         ...       ...
##   [28687]     chrY [27610116, 27611088]      * |     CpG:_76         0
##   [28688]     chrY [28555536, 28555932]      * |     CpG:_32         0
##   [28689]     chrY [28773316, 28773544]      * |     CpG:_25         0
##   [28690]     chrY [59213795, 59214183]      * |     CpG:_36         5
##   [28691]     chrY [59349267, 59349574]      * |     CpG:_29         0
##   -------
##   seqinfo: 93 sequences from hg19 genome</code></pre>
<p>The equivalent bedtools operation is</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="http://www.rdocumentation.org/packages/HelloRanges/topics/bedtools_intersect">bedtools_intersect</a></span>(<span class="st">"-a cpg.bed -b exons.bed -g hg19 -c"</span>)</code></pre></div>
<pre><code>## {
##     genome &lt;- Seqinfo(genome = "hg19")
##     gr_a &lt;- import("cpg.bed", genome = genome)
##     gr_b &lt;- import("exons.bed", genome = genome)
##     ans &lt;- gr_a
##     mcols(ans)$overlap_count &lt;- countOverlaps(gr_a, gr_b, ignore.strand = TRUE)
##     ans
## }</code></pre>
</div>
<div id="excluding-by-overlaps" class="section level2">
<h2 class="hasAnchor">
<a href="#excluding-by-overlaps" class="anchor"></a>Excluding by overlaps</h2>
<p>We can use <code>filter</code> along with the infix operator <code>%over</code> to only include CpG islands that do not overlap any exons.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cpg <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../reference/filter-overlaps.rd.html">filter_by_non_overlaps</a></span>(., exons)</code></pre></div>
<pre><code>## GRanges object with 9846 ranges and 1 metadata column:
##          seqnames               ranges strand |        name
##             &lt;Rle&gt;            &lt;IRanges&gt;  &lt;Rle&gt; | &lt;character&gt;
##      [1]     chr1     [437152, 438164]      * |     CpG:_84
##      [2]     chr1     [449274, 450544]      * |     CpG:_99
##      [3]     chr1     [533220, 534114]      * |     CpG:_94
##      [4]     chr1     [544739, 546649]      * |    CpG:_171
##      [5]     chr1     [801976, 802338]      * |     CpG:_24
##      ...      ...                  ...    ... .         ...
##   [9842]     chrY [26351344, 26352316]      * |     CpG:_76
##   [9843]     chrY [27610116, 27611088]      * |     CpG:_76
##   [9844]     chrY [28555536, 28555932]      * |     CpG:_32
##   [9845]     chrY [28773316, 28773544]      * |     CpG:_25
##   [9846]     chrY [59349267, 59349574]      * |     CpG:_29
##   -------
##   seqinfo: 93 sequences from hg19 genome</code></pre>
<p>The equivalent bedtools operation is</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="http://www.rdocumentation.org/packages/HelloRanges/topics/bedtools_intersect">bedtools_intersect</a></span>(<span class="st">"-a cpg.bed -b exons.bed -g hg19 -v"</span>)</code></pre></div>
<pre><code>## {
##     genome &lt;- Seqinfo(genome = "hg19")
##     gr_a &lt;- import("cpg.bed", genome = genome)
##     gr_b &lt;- import("exons.bed", genome = genome)
##     subsetByOverlaps(gr_a, gr_b, invert = TRUE, ignore.strand = TRUE)
## }</code></pre>
</div>
<div id="excluding-by-fraction-of-overlap" class="section level2">
<h2 class="hasAnchor">
<a href="#excluding-by-fraction-of-overlap" class="anchor"></a>Excluding by fraction of overlap</h2>
<p>A common operation is to filter ranges by the fraction they overlap a given query or subject. We can achieve this with an overlap inner join and mutate. Since an overlap inner join will keep the width of the original query ranges we can combine it with filter. In this example we filter ranges where the proportion of overlap on cpg islands is less than half.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">olap &lt;-<span class="st"> </span><span class="kw"><a href="../reference/overlap-joins.html">join_overlap_inner</a></span>(cpg, exons) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(width <span class="op">/</span><span class="st"> </span>width.x  <span class="op">&gt;=</span><span class="st"> </span><span class="fl">0.5</span>)
olap</code></pre></div>
<pre><code>## GRanges object with 12669 ranges and 5 metadata columns:
##           seqnames               ranges strand |   width.x   width.y
##              &lt;Rle&gt;            &lt;IRanges&gt;  &lt;Rle&gt; | &lt;integer&gt; &lt;integer&gt;
##       [1]     chr1     [135125, 135563]      * |       439      4924
##       [2]     chr1     [327791, 328229]      * |       439      4143
##       [3]     chr1     [327791, 328229]      * |       439      4143
##       [4]     chr1     [327791, 328229]      * |       439      1546
##       [5]     chr1     [788864, 789211]      * |       348      6056
##       ...      ...                  ...    ... .       ...       ...
##   [12665]     chrY [26979967, 26980116]      * |       227       310
##   [12666]     chrY [26979967, 26980116]      * |       227       310
##   [12667]     chrY [26979967, 26980116]      * |       227       310
##   [12668]     chrY [26979990, 26980116]      * |       227       287
##   [12669]     chrY [26979990, 26980116]      * |       227       287
##                name.x                                name.y     score
##           &lt;character&gt;                           &lt;character&gt; &lt;numeric&gt;
##       [1]     CpG:_30      NR_039983_exon_0_0_chr1_134773_r         0
##       [2]     CpG:_29      NR_028322_exon_2_0_chr1_324439_f         0
##       [3]     CpG:_29      NR_028325_exon_2_0_chr1_324439_f         0
##       [4]     CpG:_29      NR_028327_exon_3_0_chr1_327036_f         0
##       [5]     CpG:_28      NR_047519_exon_5_0_chr1_788771_f         0
##       ...         ...                                   ...       ...
##   [12665]     CpG:_21 NM_001005375_exon_0_0_chrY_26979967_f         0
##   [12666]     CpG:_21    NM_020364_exon_0_0_chrY_26979967_f         0
##   [12667]     CpG:_21    NM_020420_exon_0_0_chrY_26979967_f         0
##   [12668]     CpG:_21 NM_001005785_exon_0_0_chrY_26979990_f         0
##   [12669]     CpG:_21 NM_001005786_exon_0_0_chrY_26979990_f         0
##   -------
##   seqinfo: 93 sequences from hg19 genome</code></pre>
<p>The equivalent bedtools code is:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="http://www.rdocumentation.org/packages/HelloRanges/topics/bedtools_intersect">bedtools_intersect</a></span>(<span class="st">"-a cpg.bed -b exons.bed -g hg19 -f 0.5 -wo"</span>)</code></pre></div>
<pre><code>## {
##     genome &lt;- Seqinfo(genome = "hg19")
##     gr_a &lt;- import("cpg.bed", genome = genome)
##     gr_b &lt;- import("exons.bed", genome = genome)
##     pairs &lt;- findOverlapPairs(gr_a, gr_b, ignore.strand = TRUE)
##     olap &lt;- pintersect(pairs, ignore.strand = TRUE)
##     keep &lt;- width(olap)/width(first(pairs)) &gt;= 0.5
##     pairs &lt;- pairs[keep]
##     ans &lt;- pairs
##     mcols(ans)$overlap_width &lt;- width(olap)[keep]
##     ans
## }</code></pre>
</div>
</div>
<div id="computing-genomic-coverage" class="section level1">
<h1 class="hasAnchor">
<a href="#computing-genomic-coverage" class="anchor"></a>Computing Genomic Coverage</h1>
<p>Often we are interested in counting the number of features over an entire genome that overlap each other. In <code>plyranges</code> this is done with the <code>set_coverage</code> function in combination with other functions to manipulate the results. This function will always return a new <em>Ranges</em> object with a column called score. Any other variables associated with the input <em>Ranges</em> will be dropped.</p>
<div id="coverage-vector" class="section level2">
<h2 class="hasAnchor">
<a href="#coverage-vector" class="anchor"></a>Coverage Vector</h2>
<p>By default, <code>set_coverage</code> is equivalent to <code>bedtools genomecov -bga</code> and hence will return scores equal to zero. Filtering all scores above zero is equivalent to <code>bedtools genomecov -bg</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cvg &lt;-<span class="st"> </span>exons <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../reference/set_coverage.html">set_coverage</a></span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(score <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)
cvg</code></pre></div>
<pre><code>## GRanges object with 245860 ranges and 1 metadata column:
##                  seqnames           ranges strand |     score
##                     &lt;Rle&gt;        &lt;IRanges&gt;  &lt;Rle&gt; | &lt;integer&gt;
##        [1]           chr1   [11874, 12227]      * |         1
##        [2]           chr1   [12613, 12721]      * |         1
##        [3]           chr1   [13221, 14361]      * |         1
##        [4]           chr1   [14362, 14409]      * |         2
##        [5]           chr1   [14410, 14829]      * |         1
##        ...            ...              ...    ... .       ...
##   [245856] chrUn_gl000228 [109202, 110581]      * |         6
##   [245857] chrUn_gl000228 [112508, 112604]      * |         6
##   [245858] chrUn_gl000228 [112605, 113887]      * |         7
##   [245859] chrUn_gl000228 [114024, 114115]      * |         1
##   [245860] chrUn_gl000228 [114478, 114676]      * |         1
##   -------
##   seqinfo: 93 sequences from an unspecified genome</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="http://www.rdocumentation.org/packages/HelloRanges/topics/bedtools_genomecov">bedtools_genomecov</a></span>(<span class="st">"-i exons.bed -g hg19.genome -bg"</span>)</code></pre></div>
<pre><code>## {
##     genome &lt;- import("hg19.genome")
##     gr_a &lt;- import("exons.bed", genome = genome)
##     cov &lt;- coverage(gr_a)
##     ans &lt;- GRanges(cov)
##     ans &lt;- subset(ans, score &gt; 0)
##     ans
## }</code></pre>
</div>
<div id="coverage-histogram" class="section level2">
<h2 class="hasAnchor">
<a href="#coverage-histogram" class="anchor"></a>Coverage histogram</h2>
<p>We can construct a histogram over all seqeunces in a genome using the <code>group_by</code> and <code>summarise</code> operations along with <code>left_join</code>.</p>
<p>First, we compute the coverage over the exons and construct a <code>tibble</code> from the genome build information using <code>select</code> with <code>.drop_ranges = FALSE</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(dplyr))
cvg &lt;-<span class="st"> </span>exons <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/set_coverage.html">set_coverage</a></span>()
<span class="co"># convert the sequence annotation to a tibble</span>
hg19 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/ranges-info-get.html">get_genome_info</a></span>(cvg) <span class="op">%&gt;%</span><span class="st">  </span>
<span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(seqnames, width, <span class="dt">.drop_ranges =</span> <span class="ot">TRUE</span>)</code></pre></div>
<p>Then to count the number of bases corresponding to a score we sum over the width of each range in each chromosome. Then we join the resulting <code>tibble</code> to the annotation <code>tibble</code> called <code>hg19</code>. Note that in the sums we have coerced integer variables to doubles to avoid overflow.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cvg_hist_by_seq &lt;-<span class="st"> </span>cvg <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(seqnames, score) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="dt">count =</span> <span class="kw">sum</span>(<span class="kw">as.numeric</span>(width))) <span class="op">%&gt;%</span><span class="st">  </span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(., hg19, <span class="dt">by =</span> <span class="st">"seqnames"</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">fraction =</span> count <span class="op">/</span><span class="st"> </span>width)

cvg_hist_by_seq</code></pre></div>
<pre><code>## # A tibble: 608 x 5
##    seqnames score     count     width  fraction
##      &lt;fctr&gt; &lt;int&gt;     &lt;dbl&gt;     &lt;int&gt;     &lt;dbl&gt;
##  1     chr1     0 241996316 249250621 0.9708955
##  2     chr2     0 238060317 243199373 0.9788690
##  3     chr3     0 193800642 198022430 0.9786803
##  4     chr4     0 188206114 191154276 0.9845771
##  5     chr5     0 177466741 180915260 0.9809385
##  6     chr6     0 167349524 171115067 0.9779941
##  7     chr7     0 155623839 159138663 0.9779135
##  8     chr8     0 143743330 146364022 0.9820947
##  9     chr9     0 138299162 141213431 0.9793627
## 10    chr10     0 132497709 135534747 0.9775922
## # ... with 598 more rows</code></pre>
<p>Similarly for the genome-wide coverage histogram, we perform the same operation but do not group over <code>seqnames</code>. Finally we bind the resulting <code>tibbles</code> together.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cvg_hist_total &lt;-<span class="st"> </span>cvg <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(score) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="dt">count =</span> <span class="kw">sum</span>(<span class="kw">as.numeric</span>(width))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">seqnames =</span> <span class="st">"genome"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(.,
            hg19 <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">              </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="dt">width =</span> <span class="kw">sum</span>(<span class="kw">as.numeric</span>(width))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">              </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">seqnames =</span> <span class="st">"genome"</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">fraction =</span> count <span class="op">/</span><span class="st"> </span>width)</code></pre></div>
<pre><code>## Joining, by = "seqnames"</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cvg_hist_total</code></pre></div>
<pre><code>## # A tibble: 45 x 5
##    score      count seqnames      width     fraction
##    &lt;int&gt;      &lt;dbl&gt;    &lt;chr&gt;      &lt;dbl&gt;        &lt;dbl&gt;
##  1     0 3062406951   genome 3137161264 0.9761713515
##  2     1   44120515   genome 3137161264 0.0140638339
##  3     2   15076446   genome 3137161264 0.0048057606
##  4     3    7294047   genome 3137161264 0.0023250469
##  5     4    3650324   genome 3137161264 0.0011635755
##  6     5    1926397   genome 3137161264 0.0006140574
##  7     6    1182623   genome 3137161264 0.0003769723
##  8     7     574102   genome 3137161264 0.0001830005
##  9     8     353352   genome 3137161264 0.0001126343
## 10     9     152653   genome 3137161264 0.0000486596
## # ... with 35 more rows</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cvg_hist &lt;-<span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span>(cvg_hist_by_seq, cvg_hist_total)
cvg_hist</code></pre></div>
<pre><code>## # A tibble: 653 x 5
##    seqnames score     count     width  fraction
##       &lt;chr&gt; &lt;int&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
##  1     chr1     0 241996316 249250621 0.9708955
##  2     chr2     0 238060317 243199373 0.9788690
##  3     chr3     0 193800642 198022430 0.9786803
##  4     chr4     0 188206114 191154276 0.9845771
##  5     chr5     0 177466741 180915260 0.9809385
##  6     chr6     0 167349524 171115067 0.9779941
##  7     chr7     0 155623839 159138663 0.9779135
##  8     chr8     0 143743330 146364022 0.9820947
##  9     chr9     0 138299162 141213431 0.9793627
## 10    chr10     0 132497709 135534747 0.9775922
## # ... with 643 more rows</code></pre>
<p>Although this is slightly more verbose than the <code>bedtools</code> or <code>HelloRanges</code> approach the <code>plyranges</code> code makes the actions being performed on the input <code>Ranges</code> explicit:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="http://www.rdocumentation.org/packages/HelloRanges/topics/bedtools_genomecov">bedtools_genomecov</a></span>(<span class="st">"-i exons.bed -g hg19.genome"</span>)</code></pre></div>
<pre><code>## {
##     genome &lt;- import("hg19.genome")
##     gr_a &lt;- import("exons.bed", genome = genome)
##     cov &lt;- coverage(gr_a)
##     tablist &lt;- List(lapply(cov, table))
##     mcols(tablist)$len &lt;- lengths(cov, use.names = FALSE)
##     covhist &lt;- stack(tablist, "seqnames", "count", "coverage")
##     margin &lt;- aggregate(covhist, ~coverage, count = sum(NumericList(count)))[-1L]
##     margin &lt;- DataFrame(seqnames = Rle("genome"), margin, len = sum(as.numeric(lengths(cov))))
##     covhist &lt;- rbind(covhist, margin)
##     ans &lt;- within(covhist, fraction &lt;- count/len)
##     ans
## }</code></pre>
</div>
</div>
<div id="composing-pipelines" class="section level1">
<h1 class="hasAnchor">
<a href="#composing-pipelines" class="anchor"></a>Composing pipelines</h1>
<div id="yet-another-overlaps-example" class="section level2">
<h2 class="hasAnchor">
<a href="#yet-another-overlaps-example" class="anchor"></a>Yet another overlaps example</h2>
<p>Here we perform another example where we chain a filter and then find overlapping ranges between two ranges. In this example we reduce the exons to have zero and then find the ranges that overlap between the filtered exon ranges and the cpg islands.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">overlaps &lt;-<span class="st"> </span>exons <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(score <span class="op">==</span><span class="st"> </span>0L) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../reference/overlap-joins.html">join_overlap_inner</a></span>(.,  cpg) 

overlaps</code></pre></div>
<pre><code>## GRanges object with 45500 ranges and 5 metadata columns:
##           seqnames               ranges strand |   width.x   width.y
##              &lt;Rle&gt;            &lt;IRanges&gt;  &lt;Rle&gt; | &lt;integer&gt; &lt;integer&gt;
##       [1]     chr1     [ 29321,  29370]      - |        50      1075
##       [2]     chr1     [135125, 135563]      - |      4924       439
##       [3]     chr1     [327791, 328229]      + |      4143       439
##       [4]     chr1     [327791, 328229]      + |      4143       439
##       [5]     chr1     [327791, 328229]      + |      1546       439
##       ...      ...                  ...    ... .       ...       ...
##   [45496]     chrY [59213949, 59214117]      + |       169       389
##   [45497]     chrY [59213949, 59214117]      + |       169       389
##   [45498]     chrY [59213949, 59214117]      + |       169       389
##   [45499]     chrY [59213949, 59214117]      + |       169       389
##   [45500]     chrY [59213949, 59214117]      + |       169       389
##                                          name.x     score      name.y
##                                     &lt;character&gt; &lt;numeric&gt; &lt;character&gt;
##       [1]      NR_024540_exon_10_0_chr1_29321_r         0    CpG:_116
##       [2]      NR_039983_exon_0_0_chr1_134773_r         0     CpG:_30
##       [3]      NR_028322_exon_2_0_chr1_324439_f         0     CpG:_29
##       [4]      NR_028325_exon_2_0_chr1_324439_f         0     CpG:_29
##       [5]      NR_028327_exon_3_0_chr1_327036_f         0     CpG:_29
##       ...                                   ...       ...         ...
##   [45496] NM_001145149_exon_0_0_chrY_59213949_f         0     CpG:_36
##   [45497] NM_001185183_exon_0_0_chrY_59213949_f         0     CpG:_36
##   [45498]    NM_005638_exon_0_0_chrY_59213949_f         0     CpG:_36
##   [45499]    NR_033714_exon_0_0_chrY_59213949_f         0     CpG:_36
##   [45500]    NR_033715_exon_0_0_chrY_59213949_f         0     CpG:_36
##   -------
##   seqinfo: 93 sequences from hg19 genome</code></pre>
<p>We can also compute the coverage histogram of exons over cpg islands and then plot results as an ecdf.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cvg_over_exons &lt;-<span class="st"> </span>exons <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../reference/set_coverage.html">set_coverage</a></span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/overlap-joins.html">join_overlap_inner</a></span>(., cpg) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">total =</span> <span class="kw">sum</span>(<span class="kw">as.numeric</span>(width))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(score) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="dt">count =</span> <span class="kw">sum</span>(<span class="kw">as.numeric</span>(width)),
            <span class="dt">fraction =</span> count <span class="op">/</span><span class="st"> </span><span class="kw">unique</span>(total)) 

cvg_over_exons</code></pre></div>
<pre><code>## # A tibble: 28 x 3
##    score    count     fraction
##    &lt;int&gt;    &lt;dbl&gt;        &lt;dbl&gt;
##  1     0 14607020 0.6687356377
##  2     1  4644079 0.2126142862
##  3     2  1431318 0.0655283114
##  4     3   581001 0.0265992704
##  5     4   245183 0.0112249186
##  6     5   137255 0.0062837807
##  7     6    84053 0.0038480975
##  8     7    41162 0.0018844704
##  9     8    32327 0.0014799882
## 10     9     9186 0.0004205516
## # ... with 18 more rows</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span><span class="kw">cumsum</span>(fraction) <span class="op">~</span><span class="st"> </span>score, <span class="dt">data =</span> cvg_over_exons, 
     <span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">25</span>), 
     <span class="dt">type=</span> <span class="st">"l"</span>, 
     <span class="dt">xlab =</span> <span class="st">"coverage"</span>, 
     <span class="dt">ylab =</span> <span class="st">"fraction of bp &gt; coverage"</span>)</code></pre></div>
<p><img src="02-bedtools-examples_files/figure-html/unnamed-chunk-15-1.png" width="672"></p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#data">Data</a></li>
      <li><a href="#reading-bed-files">Reading BED files</a></li>
      <li>
<a href="#intersections-and-overlaps">Intersections and Overlaps</a><ul class="nav nav-pills nav-stacked">
<li><a href="#keeping-the-original-features">Keeping the original features</a></li>
      <li><a href="#computing-the-amount-of-overlap">Computing the amount of overlap</a></li>
      <li><a href="#counting-the-number-of-overlaps">Counting the number of overlaps</a></li>
      <li><a href="#excluding-by-overlaps">Excluding by overlaps</a></li>
      <li><a href="#excluding-by-fraction-of-overlap">Excluding by fraction of overlap</a></li>
      </ul>
</li>
      <li>
<a href="#computing-genomic-coverage">Computing Genomic Coverage</a><ul class="nav nav-pills nav-stacked">
<li><a href="#coverage-vector">Coverage Vector</a></li>
      <li><a href="#coverage-histogram">Coverage histogram</a></li>
      </ul>
</li>
      <li>
<a href="#composing-pipelines">Composing pipelines</a><ul class="nav nav-pills nav-stacked">
<li><a href="#yet-another-overlaps-example">Yet another overlaps example</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Stuart Lee, Michael Lawrence, Dianne Cook.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
